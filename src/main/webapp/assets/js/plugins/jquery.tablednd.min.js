jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(e){return e=e||{},this.each(function(){this.tableDnDConfig={onDragStyle:e.onDragStyle,onDropStyle:e.onDropStyle,onDragClass:e.onDragClass?e.onDragClass:"tDnD_whileDrag",onDrop:e.onDrop,onDragStart:e.onDragStart,scrollAmount:e.scrollAmount?e.scrollAmount:5},jQuery.tableDnD.makeDraggable(this)}),jQuery(document).bind("mousemove",jQuery.tableDnD.mousemove).bind("mouseup",jQuery.tableDnD.mouseup),this},makeDraggable:function(e){for(var t=e.rows,n=e.tableDnDConfig,r=0;r<t.length;r++){var o=$(t[r]).hasClass("nodrag");o||jQuery(t[r]).mousedown(function(t){return"TD"==t.target.tagName?(jQuery.tableDnD.dragObject=this,jQuery.tableDnD.currentTable=e,jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,t),n.onDragStart&&n.onDragStart(e,this),!1):void 0}).css("cursor","move")}},mouseCoords:function(e){return e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(e,t){t=t||window.event;var n=this.getPosition(e),r=this.mouseCoords(t);return{x:r.x-n.x,y:r.y-n.y}},getPosition:function(e){var t=0,n=0;for(0==e.offsetHeight&&(e=e.firstChild);e.offsetParent;)t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;return t+=e.offsetLeft,n+=e.offsetTop,{x:t,y:n}},mousemove:function(e){if(null!=jQuery.tableDnD.dragObject){var t=jQuery(jQuery.tableDnD.dragObject),n=jQuery.tableDnD.currentTable.tableDnDConfig,r=jQuery.tableDnD.mouseCoords(e),o=r.y-jQuery.tableDnD.mouseOffset.y,l=window.pageYOffset;if(document.all&&("undefined"!=typeof document.compatMode&&"BackCompat"!=document.compatMode?l=document.documentElement.scrollTop:"undefined"!=typeof document.body&&(l=document.body.scrollTop)),r.y-l<n.scrollAmount)window.scrollBy(0,-n.scrollAmount);else{var a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;a-(r.y-l)<n.scrollAmount&&window.scrollBy(0,n.scrollAmount)}if(o!=jQuery.tableDnD.oldY){var u=o>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=o,n.onDragClass?t.addClass(n.onDragClass):t.css(n.onDragStyle);var D=jQuery.tableDnD.findDropTargetRow(t,o);D&&(u&&jQuery.tableDnD.dragObject!=D?jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,D.nextSibling):u||jQuery.tableDnD.dragObject==D||jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,D))}return!1}},findDropTargetRow:function(e,t){for(var n=jQuery.tableDnD.currentTable.rows,r=0;r<n.length;r++){var o=n[r],l=this.getPosition(o).y,a=parseInt(o.offsetHeight)/2;if(0==o.offsetHeight&&(l=this.getPosition(o.firstChild).y,a=parseInt(o.firstChild.offsetHeight)/2),t>l-a&&l+a>t){if(o==e)return null;var u=jQuery.tableDnD.currentTable.tableDnDConfig;if(u.onAllowDrop)return u.onAllowDrop(e,o)?o:null;var D=$(o).hasClass("nodrop");return D?null:o}}return null},mouseup:function(){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){var e=jQuery.tableDnD.dragObject,t=jQuery.tableDnD.currentTable.tableDnDConfig;t.onDragClass?jQuery(e).removeClass(t.onDragClass):jQuery(e).css(t.onDropStyle),jQuery.tableDnD.dragObject=null,t.onDrop&&t.onDrop(jQuery.tableDnD.currentTable,e),jQuery.tableDnD.currentTable=null}},serialize:function(){if(jQuery.tableDnD.currentTable){for(var e="",t=jQuery.tableDnD.currentTable.id,n=jQuery.tableDnD.currentTable.rows,r=0;r<n.length;r++)e.length>0&&(e+="&"),e+=t+"[]="+n[r].id;return e}return"Error: No Table id set, you need to set an id on your table and every row"}},jQuery.fn.extend({tableDnD:jQuery.tableDnD.build});